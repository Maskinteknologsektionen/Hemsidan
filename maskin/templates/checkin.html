{% extends "base.html" %}
{% load cms_tags %}
{% load i18n %}

{% block title %}{% trans 'Check in' %}{% endblock title %}

{% block content %}
    <div class="row">
        <div class="col main-content">
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <select class="form-control" id="event-picker">
                                <option data-id="0">-- {% trans 'Pick event' %} --</option>
                                {% for event in events %}
                                    <option data-id="{{ event.id }}">{{ event.name }} {{ event.start|date:'Y-m-d H:i' }}</option>
                                {% endfor %}
                        </select>
                    </div>
                    <div class="collapse" id="listpicker">
                        <div class="form-group">
                            <button class="btn btn-maskin btn-list" data-target="#signups-tab"><i class="fa fa-list" aria-hidden="true"></i> {% trans 'Signup list' %}</button>
                            <button class="btn btn-maskin btn-list" data-target="#checkins-tab"><i class="fa fa-check" aria-hidden="true"></i> {% trans 'Check-in' %}</button>
                            <span class="collapse" id="inputpicker">
                                <button class="btn btn-maskin btn-input" data-target="#search"><i class="fa fa-search" aria-hidden="true"></i> {% trans 'Search' %}</button>
                                <button class="btn btn-maskin btn-input" data-target="#blip"><i class="fa fa-credit-card" aria-hidden="true"></i> <i class="fa fa-rss" aria-hidden="true"></i> {% trans 'Blip' %}</button>
                            </span>
                        </div>
                    </div>
                    <div class="alert alert-danger collapse" role="alert" id="errormsg"></div>
                    <div class="collapse form-group inputdiv" id="search">
                            <input class="form-control" type="text" id="search_field" placeholder="{% trans 'Search' %}">
                        <div class="row">
                            <div class="col" id="search_results"></div>
                        </div>
                    </div>
                    <div class="collapse form-group inputdiv" id="blip">
                        <input class="form-control" type="text" id="blip_field" placeholder="{% trans 'Blip' %}">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col" id="signups"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="remove-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans 'Remove sign up' %}</h5>
                </div>
                <div class="modal-body">
                    <p>{% trans 'Do you want to remove the check-in for:' %} <b><span id="remove-user"></span></b> {% trans 'on event:' %} <b><span id="remove-event"></span></b>?</p>
                    <button type="button" id="remove-checkin" class="btn btn-maskin">{% trans "Yes, I'm sure." %}</button>
                    <button type="button" data-dismiss="modal" class="btn btn-secondary">{% trans 'No' %}</button>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block javascript %}
     <script>
    $("#search_field").keyup(function () {
        var eventid = $("#event-picker option:selected").data('id');
        if(this.value.length > 2 && eventid!=0) {
            $.ajax({
                url: '/{{ LANGUAGE_CODE }}/ajax/search',
                data: {
                    'query': $(this).val(),
                    'eventid': eventid,
                },
                datatype: 'html',
                success: function (data) {
                    $("#search_results").html(data);
                    $("#errormsg").hide();
                }
            });
        }
    });
    $("#blip_field").keyup(function (e) {

        if(e.which == 13) { // Hit enter
            $.ajax({
                url: '/{{ LANGUAGE_CODE }}/ajax/blip',
                data: {
                    'query': $(this).val(),
                    'eventid': $("#event-picker option:selected").data('id'),
                },
                datatype: 'html',
                success: function (data) {
                    updatesignups(data);
                    $("#blip_field").val("");
                },
                error: function (data) {
                    if (data.status == 400){
                        $("#errormsg").text(data.responseJSON.msg);
                    }else{
                        $("#errormsg").text('Unknown error');
                    }
                    $("#errormsg").show();
                    $("#blip_field").val("");
                }
            });
        }
    });
    $(".btn-input").on('click', function () {
        $(".btn-input").removeClass('active');
        $(this).addClass('active');
        var target=$(this).data('target');
        $(target+" > input").val("");
        $(target).show();
        $(".inputdiv:not("+target+")").hide();
    });

    $(".btn-list").on('click', function () {
        $(".btn-list").removeClass('active');
        $(this).addClass('active');
        var target=$(this).data('target');
        $(target).show();
        if(target=="#checkins-tab"){
            $("#inputpicker").show();
        }else{
            $("#inputpicker").hide();
            $(".btn-input").removeClass('active');
            $(".inputdiv").hide();
        }
        $(".listdiv:not("+target+")").hide();
    });

    $("#event-picker").on('change', function () {
        var id=$("#event-picker option:selected").data('id');
        if(id==0){
            $("#signups").hide();
            $("#listpicker").hide();
            $("#inputpicker").hide();
            $(".inputdiv").hide();
        }else{
            $.ajax({
            url: '/{{ LANGUAGE_CODE }}/ajax/signups',
            data: {'eventid': id},
            datatype: 'html',
                success: function (data) {
                    $("#signups").show();
                    updatesignups(data);
                    $("#listpicker").show();
                    $(".btn-list").removeClass('active');
                    $(".btn-input").removeClass('active');

                }
            });
        }

    });

    $('.main-content').on('click', '.member-btn', function () {
        var liuid=$(this).data('liuid');
        var eventid=$("#event-picker option:selected").data('id');
        $.ajax({
            url: '/{{ LANGUAGE_CODE }}/ajax/add_member',
            data: {
                'liuid': liuid,
                'eventid': eventid,
            },
            datatype: 'html',
                success: function (data) {
                    updatesignups(data);
                }
        });
    });

    $('.main-content').on('click', '.checkin-btn', function () {
        var btn = $(this);
        var liuid=$(this).data('liuid');
        var eventid=$("#event-picker option:selected").data('id');
        $.ajax({
            url: '/{{ LANGUAGE_CODE }}/ajax/checkin',
            data: {
                'liuid': liuid,
                'eventid': eventid,
            },
            datatype: 'html',
                success: function (data) {
                    updatesignups(data);
                    btn.text('{% trans 'Already checked in' %}');
                    btn.removeClass('btn-maskin');
                    btn.addClass('btn-light');
                }
        });
    });

    $('.main-content').on('click', '.remove-btn', function () {
        var liuid=$(this).data('liuid');
        var eventname=$("#event-picker option:selected").val();
        $("#remove-user").text(liuid);
        $("#remove-checkin").data('liuid', liuid);
        $("#remove-event").text(eventname);
        $("#remove-modal").modal('show');
    });

    $("#remove-checkin").on('click', function () {
        var liuid=$(this).data('liuid');
        var eventid=$("#event-picker option:selected").data('id');
        $.ajax({
            url: '/{{ LANGUAGE_CODE }}/ajax/remove_checkin',
            data: {
                'liuid': liuid,
                'eventid': eventid,
            },
            datatype: 'html',
                success: function (data) {
                    updatesignups(data);
                    $("#remove-modal").modal('hide');

                }
        });
    });

    function updatesignups(data) {
        $("#signups").html(data);
        $("#errormsg").hide();
        var target = $(".btn-list.active").data('target');
        $(target).show();

    }
  </script>
{% endblock javascript %}
